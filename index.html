<!doctype html>
<html lang="en">
<head>
  <link rel="icon" type="image/jpg" href="img/logo.jpg">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>See the Pattern · Video Archive</title>
  <meta name="description" content="Browse See the Pattern videos by topic. Lightweight, fast, no embeds — thumbnails, links, references, and sponsor placements." />
  <style>
    :root{
      --bg:#0b0c10; --card:#12141a; --muted:#a0a6b3; --text:#e7ecf5; --acc:#6bdcff; --chip:#1a1d25;
      --radius:16px; --shadow:0 6px 24px rgba(0,0,0,.25);
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--text);font:16px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial}
    a{color:var(--acc);text-decoration:none}
    a:hover{text-decoration:underline}
    .wrap{max-width:1100px;margin:auto;padding:28px}
    header{display:flex;flex-wrap:wrap;gap:14px;align-items:center;justify-content:space-between;margin-bottom:8px}
    .title{font-weight:700;letter-spacing:.2px}
    .title span{opacity:.7;font-weight:500}
    .controls{display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin:10px 0}
    input[type="search"], select{background:var(--card);border:1px solid #232736;color:var(--text);border-radius:12px;padding:10px 12px;min-width:240px;box-shadow:var(--shadow)}
    nav .btn{display:inline-flex;align-items:center;gap:8px;background:#101319;border:1px solid #22304a;padding:8px 10px;border-radius:10px;color:#dfe7ff;margin-right:8px}
    nav .btn:hover{background:#0e1118}
    .chips{display:flex;flex-wrap:wrap;gap:8px;margin:10px 0 4px}
    .chip{background:var(--chip);border:1px solid #2a2f3a;color:var(--muted);padding:6px 10px;border-radius:999px;cursor:pointer}
    .chip.active{color:#fff;border-color:var(--acc)}
	
	/* Responsive grid — desktop uses multiple columns, mobile switches to full-width */
	.grid {
	  display: grid;
	  grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
	  gap: 22px;
	  margin-top: 18px;
	}

	@media (max-width: 720px) {
	  .grid {
		grid-template-columns: 1fr; /* single column layout on small screens */
		gap: 18px;
	  }
	}

	/* Card styling with subtle hover and breathing pulse */
	.card {
	  background: var(--card);
	  border: 1px solid #232736;
	  border-radius: var(--radius);
	  overflow: hidden;
	  box-shadow: var(--shadow);
	  display: flex;
	  flex-direction: column;
	  transition: transform 0.2s ease, box-shadow 0.2s ease;
	  
	}

	.card:hover {
	  transform: translateY(-3px);
	  box-shadow: 0 8px 28px rgba(0,0,0,0.4);
	}

	/* Thumbnail size + slight floating depth */
	.thumb {
	  aspect-ratio: 16 / 9;
	  background: #0f1117;
	  position: relative;
	  overflow: hidden;
	}
	.thumb img {
	  width: 100%;
	  height: 100%;
	  object-fit: cover;
	  display: block;
	  transition: transform 0.8s ease;
	}
	.card:hover .thumb img {
	  transform: scale(1.02);
	}



	/* Text layout tweaks */
	.body { padding: 14px 16px; }
	.titleLine {
	  font-weight: 600;
	  margin: 4px 0 8px;
	  font-size: 1rem;
	  line-height: 1.3;
	}
	.meta {
	  font-size: 0.9rem;
	  color: var(--muted);
	}


	/* Text adjustments for bigger cards */
	.body {
	  padding: 14px 16px;
	}

	.titleLine {
	  font-weight: 600;
	  margin: 4px 0 8px;
	  font-size: 1rem;
	  line-height: 1.3;
	}
	.meta {
	  font-size: 0.9rem;
	  color: var(--muted);
	}

    .badge{position:absolute;left:10px;bottom:10px;background:rgba(0,0,0,.6);border:1px solid rgba(255,255,255,.15);padding:2px 8px;border-radius:999px;font-size:12px;color:#d9e2ef}
    .body{padding:12px 14px}
    .titleLine{font-weight:600;margin:2px 0 6px}
    .meta{font-size:13px;color:var(--muted)}
    .topics{display:flex;flex-wrap:wrap;gap:6px;margin-top:8px}
    .topic{font-size:12px;color:#c3d2ff;background:#141824;border:1px solid #23324a;border-radius:999px;padding:2px 8px}
    .actions{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}
    .btn{display:inline-flex;align-items:center;gap:8px;background:#101319;border:1px solid #22304a;padding:8px 10px;border-radius:10px;color:#dfe7ff}
    .btn:hover{background:#0e1118}
    .empty{opacity:.8;text-align:center;padding:60px 16px;border:1px dashed #2a2f3a;border-radius:14px;margin-top:24px}
    footer{color:var(--muted);font-size:14px;margin:30px 0 10px}
    .count{opacity:.8}
    .sponsorbar{display:flex;gap:18px;align-items:center;flex-wrap:wrap;margin-top:28px;padding:12px 0;border-top:1px solid #232736}
    .sponsorbar img{height:28px;width:auto;opacity:.9;filter:saturate(0.9)}

    /* Detail view */
    #detail{display:none}
    .detailHead{display:flex;gap:18px;align-items:center;flex-wrap:wrap;margin:8px 0 14px}
    .pill{font-size:12px;border:1px solid #2a2f3a;border-radius:999px;padding:4px 10px;color:#c7d2e8;background:#0f1219}
    .refgroup{margin:16px 0}
    .refgroup h3{font-size:15px;margin:0 0 8px;color:#cdd7ee}
    .refgroup ul{margin:0;padding-left:18px}
    .refgroup li{margin:6px 0}
    .divider{height:1px;background:#232736;margin:20px 0}
    .back{margin:4px 0 8px;display:inline-flex;gap:8px;align-items:center}

    @media (max-width:540px){ input[type="search"]{min-width:unset;width:100%} }
	:root{
  --desc-lines: 4; /* default for archive cards */
	}

	/* Clamp card titles to 2 lines */
	.titleLine a{
	  display: -webkit-box;
	  -webkit-line-clamp: 2;
	  -webkit-box-orient: vertical;
	  overflow: hidden;
	}

	/* Clamp card descriptions to N lines (uses --desc-lines) */
	.meta.card-desc{
	  display: -webkit-box;
	  -webkit-line-clamp: var(--desc-lines);
	  -webkit-box-orient: vertical;
	  overflow: hidden;
	}
	
	/* Related video cards */
	.related-grid {
	  display: grid;
	  grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
	  gap: 16px;
	}

	.related-card {
	  background: #101319;
	  border: 1px solid #22304a;
	  border-radius: 14px;
	  overflow: hidden;
	  box-shadow: 0 4px 12px rgba(0,0,0,0.25);
	  transition: transform 0.2s ease, box-shadow 0.2s ease;
	}
	.related-card:hover {
	  transform: translateY(-3px);
	  box-shadow: 0 6px 16px rgba(0,0,0,0.35);
	}

	/* Related video cards — show full image, no cropping */
	.related-card .thumb {
	  position: relative;
	  width: 100%;
	  aspect-ratio: 16 / 9;
	  background: #000;           /* letterbox bars */
	  overflow: hidden;
	  border-bottom: 1px solid #22304a;
	}
	.related-card .thumb img {
	  width: 100%;
	  height: 100%;
	  object-fit: contain;         /* <-- was cover */
	  object-position: center center;
	  display: block;
	}

	/* Gentle, single-shot pulse for sponsor logos */
	@keyframes sponsorBreathe {
	  0%, 100% { transform: scale(1); }
	  40%      { transform: scale(1.10); }
	  65%      { transform: scale(1.05); }
	}


	/* class applied by JS when a pulse is triggered */
	.sponsor-breathe {
	  animation: sponsorBreathe 2.2s ease-in-out 1;
	}

	/* Respect user accessibility setting */
	@media (prefers-reduced-motion: reduce) {
	  .sponsor-breathe { animation: none !important; }
	}


	/* text section */
	.related-card .body {
	  padding: 10px 12px;
	}
	.related-card .titleLine {
	  font-size: 14px;
	  line-height: 1.3;
	  font-weight: 600;
	  margin-bottom: 4px;
	}
	.related-card .meta {
	  font-size: 12px;
	  opacity: 0.8;
	}
	.related-card .body {
	  padding: 8px 10px;
	  background: #0e1015;
	  border-top: 1px solid #1c2638;
	}
	.related-card .titleLine {
	  font-size: 14px;
	  font-weight: 600;
	  line-height: 1.3;
	  color: #e0e6f0;
	  margin-bottom: 2px;
	}
	.related-card .meta {
	  font-size: 12px;
	  opacity: 0.8;
	  color: #a8b0c0;
	}
	.related-card:hover .titleLine {
	  color: #5ab1ff;
	}
	
	/* NAVBAR — keeps buttons and sponsors perfectly aligned horizontally */
	.navbar {
	  display: flex;
	  align-items: center;          /* vertically center both buttons and logos */
	  justify-content: space-between;
	  gap: 16px;
	  flex-wrap: nowrap;            /* prevent wrapping onto next line */
	  margin-bottom: 10px;
	  flex-shrink: 0;
	  white-space: nowrap;
	}

	.nav-left {
	  display: flex;
	  align-items: center;
	  gap: 8px;
	}

	/* SPONSOR BAR — compact right-side layout */
	.sponsorbar-top {
	  display: flex;
	  align-items: center;
	  justify-content: flex-end;
	  gap: 10px;
	  margin: 0;
	  padding: 0;
	  border: none;
	}

	.sponsorbar-top span.meta {
	  font-size: 0.9em;
	  color: var(--meta-color, #aaa);
	}

	.sponsorbar-top img {
	  height: 36px;
	  width: auto;
	  opacity: 0.95;
	  filter: saturate(0.95);
	  transition: transform 0.2s ease;
	}

	.sponsorbar-top img:hover {
	  transform: scale(1.05);
	}

	/* Responsive: stack only if viewport is narrow */
	@media (max-width: 640px) {
	  .navbar {
		flex-wrap: wrap;            /* allow stacking on very small screens */
		justify-content: center;
	  }
	  .sponsorbar-top {
		justify-content: center;
		margin-top: 6px;
	  }
	}


  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="title">See the Pattern <span>· archive</span></div>
      <div class="controls" id="controls">
        <input id="q" type="search" placeholder="Search titles & notes… (e.g. plasma, CMB, SN1a)" />
        <select id="sort">
          <option value="newest">Newest first</option>
          <option value="oldest">Oldest first</option>
          <option value="az">A → Z</option>
          <option value="za">Z → A</option>
        </select>
		<button id="compactBtn" class="btn" type="button" title="Toggle compact card layout">
			Compact cards
		</button>
      </div>
    </header>

	<nav class="navbar">
	  <div class="nav-left">
		<a class="btn" href="#" id="navArchive">Archive</a>
		<a class="btn" href="#support">Support</a>
		<a class="btn" href="#contact">Contact</a>
	  </div>

	  <!-- New top sponsor bar -->
	  <div id="sponsorbar-top" class="sponsorbar sponsorbar-top" aria-label="Sponsors"></div>
	</nav>

    <div id="archive">
      <div class="chips" id="chips"></div>
      <div class="count" id="count"></div>
      <div id="grid" class="grid"></div>
      <div id="empty" class="empty" style="display:none">No results. Try clearing filters.</div>
      <div id="sponsorbar-archive" class="sponsorbar"></div>
    </div>

    <div id="detail">
      <a class="back" href="#" id="backArchive">← Back to archive</a>
      <div class="detailHead">
        <div id="dTitle" class="title" style="font-size:18px"></div>
        <span id="dDate" class="pill"></span>
        <span id="dTopics" class="pill"></span>
      </div>
      <div class="thumb" style="max-width:760px;border-radius:12px;overflow:hidden">
        <img id="dThumb" alt="" />
        <span id="dBadge" class="badge"></span>
      </div>
      <div class="actions" style="margin-top:12px">
        <a id="dWatch" class="btn" target="_blank" rel="noopener">Watch on YouTube</a>
      </div>
      <p id="dNotes" class="meta" style="margin-top:10px"></p>
      <div class="divider"></div>
      <section id="refs"></section>
	  <section id="related"></section>
      <div id="sponsorbar-detail" class="sponsorbar"></div>
    </div>

    <section id="support" style="display:none">
      <h2 style="margin:6px 0 10px">Support See the Pattern</h2>
      <p class="meta">If you find the work valuable, here are simple ways to support it. Thank you for helping keep the research and edits going.</p>
      <div class="actions">
        <a class="btn" id="lPatreon" target="_blank" rel="noopener">Patreon</a>
        <a class="btn" id="lKofi" target="_blank" rel="noopener">Ko‑fi</a>
        <a class="btn" id="lPaypal" target="_blank" rel="noopener">PayPal</a>
        <a class="btn" id="lMerch" target="_blank" rel="noopener">Merch</a>
      </div>
      <div class="divider"></div>
      <p class="meta">Prefer to share instead? A direct link to a favourite episode helps more than you think.</p>
      <div id="sponsorbar-support" class="sponsorbar"></div>
    </section>

    <section id="contact" style="display:none">
      <h2 style="margin:6px 0 10px">Contact & Commercial Inquiries</h2>
      <p class="meta">For sponsorships, speaking, or collaboration proposals, please email:</p>
      <p><a class="btn" id="bizEmail"></a></p>
      <ul class="meta" style="margin-top:10px">
        <li>Audience: science‑curious, long‑form video viewers (cosmology, plasma physics, alternative models).</li>
        <li>Formats: 30–60s integrations; sponsor logo on website (time‑boxed); dedicated landing links.</li>
        <li>We value relevance and integrity. Products/services must genuinely serve the audience.</li>
      </ul>
      <div class="divider"></div>
      <p class="meta">Press/media: please include deadlines and time zones. A short brief helps accelerate a response.</p>
      <div id="sponsorbar-contact" class="sponsorbar"></div>
    </section>

    <footer>Plain HTML. No embeds. Thumbnails + deep links to YouTube. · <a href="#" id="shareArchive">Download full video list (JSON)</a></footer>
  </div>

<script>
// ======== Data fallbacks (edit these) =========


const SPONSORS_FALLBACK = [
  // { brand:"Manta Sleep", logo:"/img/manta.png", link:"/manta", expires:"2025-12-31", disclosure:"Paid promotion" },
];

// Support & Contact links
const SUPPORT_LINKS = {
  patreon: "https://patreon.com/SeeThePattern",
  kofi: "https://ko-fi.com/seethepattern",
  paypal: "https://paypal.me/seethepattern",
  merch: "https://see-the-pattern.myspreadshop.co.uk/"
};
const CONTACT = {
  email: "contact@seethepattern.com"
};
// ===================================

// Fallback → external JSON loader
let VIDEOS = [];
let SPONSORS = [];

async function loadJSON(url){
  const res = await fetch(url, { cache: 'no-store' });
  if(!res.ok) throw new Error(`HTTP ${res.status} for ${url}`);
  return res.json();
}


// --- CSV helper ---
async function loadText(url){
  const res = await fetch(url, { cache: 'no-store' });
  if(!res.ok) throw new Error(`HTTP ${res.status} for ${url}`);
  return res.text();
}

function parseCSV(text){
  // Strip UTF-8 BOM if present
  if (text.charCodeAt(0) === 0xFEFF) text = text.slice(1);

  const rows=[]; let i=0, cur='', inQ=false, row=[];
  function pushCell(){ row.push(cur); cur=''; }
  function pushRow(){ rows.push(row); row=[]; }

  while(i<text.length){
    const c=text[i++];
    if(inQ){
      if(c === '"'){
        if(text[i] === '"'){ cur += '"'; i++; } else { inQ = false; }
      } else { cur += c; }
    }else{
      if(c === '"'){ inQ = true; }
      else if(c === ','){ pushCell(); }
      else if(c === '\n'){ pushCell(); pushRow(); }
      else if(c === '\r'){ /* ignore */ }
      else { cur += c; }
    }
  }
  if(cur !== '' || row.length){ pushCell(); pushRow(); }

  const header = (rows.shift()||[]).map(h=>String(h||'').trim());
  return rows
    .filter(r => r.some(x => String(x).trim().length))
    .map(r => {
      const o={}; header.forEach((h,idx)=>{ o[h] = (r[idx]??'').trim(); });
      return o;
    });
}

function normalizeRefUrl(raw){
  if(!raw) return '';
  const s = String(raw).trim();

  // DOI patterns
  const doiBare = /^10\.\d{4,9}\/\S+$/i;          // 10.xxxx/...
  const doiPref = /^doi:\s*(.+)$/i;               // doi: 10.xxxx/...
  // arXiv patterns
  const arxivBare = /^\d{4}\.\d{4,5}(v\d+)?$/i;   // 2023.01234 or 2023.01234v2
  const arxivPref = /^arxiv:\s*(.+)$/i;           // arXiv: 2023.01234

  if(doiBare.test(s)) return `https://doi.org/${s}`;
  const mD = s.match(doiPref);
  if(mD) return `https://doi.org/${mD[1].trim()}`;

  if(arxivBare.test(s)) return `https://arxiv.org/abs/${s}`;
  const mA = s.match(arxivPref);
  if(mA) return `https://arxiv.org/abs/${mA[1].trim()}`;

  // Accept only http(s) URLs
  try{
    const u = new URL(s);
    if(u.protocol === 'http:' || u.protocol === 'https:') return u.href;
  }catch{ /* not a URL */ }

  return '';
}

function splitRefs(cell){
  return (cell || '')
    .split(/\s*;\s*/).filter(Boolean)
    .map(s => {
      const p = s.split('|').map(x=>x.trim());
      if (p.length === 1) {
        // text-only reference: no link
        return { t: p[0] };
      }
      const [t, rawU, n] = p;
      const url = normalizeRefUrl(rawU);
      const out = { t: t || rawU };
      if (url) out.u = url;   // only set u when valid
      if (n) out.n = n;
      return out;
    });
}

// returns the first non-empty field from a list of possible header names
function getField(row, ...alts){
  for (const k of alts){
    if (k in row && row[k] && String(row[k]).trim() !== '') return row[k];
  }
  return '';
}

function ytIdFromUrl(u){
  if(!u) return '';
  try{
    const url=new URL(u);
    if(url.hostname.includes('youtu.be')) return url.pathname.slice(1);
    return url.searchParams.get('v') || '';
  }catch{ return ''; }
}

function upgradeYouTubeThumb(imgEl, videoUrl){
  const id = ytIdFromUrl(videoUrl);
  if(!id || !imgEl) return;
  const test = new Image();
  test.onload = () => { imgEl.src = `https://img.youtube.com/vi/${id}/maxresdefault.jpg`; };
  // if it 404s, we keep the hqdefault already on the page
  test.src = `https://img.youtube.com/vi/${id}/maxresdefault.jpg`;
}

function mapVideoRow(row){
  const id  = (row.id||'').trim().toLowerCase().replace(/_/g,'-');
  const url = (row.url||'').trim();

  // thumbnail: CSV > YouTube fallback
  const yt  = ytIdFromUrl(url);
  let thumb = (row.thumb||'').trim();
  if(!thumb && yt) thumb = `https://img.youtube.com/vi/${yt}/hqdefault.jpg`;

  return {
    id,
    title: row.title || '',
    url,
    date:  (row.date || '').trim(),
    topics: (row.topics || '').split(';').map(s=>s.trim()).filter(Boolean),
    thumb,
    notes: row.notes || '',
    refs: {
      papers:   splitRefs(getField(row, 'ref_papers','ref_paper','papers','paper','refpaper')),
      books:    splitRefs(getField(row, 'ref_books','ref_book','books','book','refbook')),
      talks:    splitRefs(getField(row, 'ref_talks','ref_talk','talks','talk','reftalk')),
      datasets: splitRefs(getField(row, 'ref_datasets','ref_dataset','datasets','dataset','refdataset')),
      other:    splitRefs(getField(row, 'ref_other','ref_misc','other','misc','refother','refmisc')),
    },
    // IMPORTANT: related is a top-level field, not inside refs
    related: (row.related || '').split(';').map(s=>s.trim()).filter(Boolean)
  };
}


async function loadData(){
  try {
    // Try JSON first
    VIDEOS = await loadJSON('data/videos.json');
    console.log('Loaded videos.json');
  } catch {
    try {
      // Then try CSV
      const csv = await loadText('data/videos.csv');
      VIDEOS = parseCSV(csv).map(mapVideoRow);
      console.log('Loaded videos.csv:', VIDEOS.length, 'entries');
    } catch {
      // Fall back to inline
      console.warn('Using fallback VIDEOS');
      VIDEOS = VIDEOS_FALLBACK;
    }
  }

  try {
    SPONSORS = await loadJSON('data/sponsors.json');
  } catch {
    try {
      const csv = await loadText('data/sponsors.csv');
      SPONSORS = parseCSV(csv);
    } catch {
      console.warn('Using fallback SPONSORS');
      SPONSORS = SPONSORS_FALLBACK;
    }
  }
  renderSponsors('#sponsorbar-top');
}


// Utilities
const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));

const chipsEl = $('#chips');
const gridEl = $('#grid');
const emptyEl = $('#empty');
const qEl = $('#q');
const sortEl = $('#sort');
const countEl = $('#count');
const archiveEl = $('#archive');
const detailEl = $('#detail');
const compactBtn = document.getElementById('compactBtn');
let compactMode = true;  // start compact by default

function uniq(arr){ return [...new Set(arr)] }
function getAllTopics(){ return uniq(VIDEOS.flatMap(v => v.topics||[])).sort((a,b)=>a.localeCompare(b)) }
function todayStr(){ return new Date().toISOString().slice(0,10) }
function activeSponsors(){
  const now = todayStr();
  return (SPONSORS||[]).filter(s => !s.expires || s.expires >= now);
}
function renderSponsors(targetId){
  const el = $(targetId);
  const live = activeSponsors();
  el.innerHTML = '';
  if(!live.length) return;
  const label = document.createElement('span');
  label.className = 'meta';
  label.textContent = 'Supported by';
  el.appendChild(label);
  for(const s of live){
    const a = document.createElement('a'); a.href = s.link; a.target = '_blank'; a.rel = 'noopener'; a.title = (s.disclosure? s.disclosure+': ':'') + s.brand;
    const img = document.createElement('img'); img.alt = s.brand; img.src = s.logo; a.appendChild(img);
    el.appendChild(a);
  }
}

let state = { q: new URLSearchParams(location.search).get('q') || '', topics: new Set(), sort: 'newest' };

function buildChips(){
  chipsEl.innerHTML = '';
  const all = getAllTopics();
  for(const t of all){
    const b = document.createElement('button');
    b.className = 'chip';
    b.textContent = t;
    b.onclick = () => { state.topics.has(t) ? state.topics.delete(t) : state.topics.add(t); renderArchive(); };
    chipsEl.appendChild(b);
  }
}

function applyFilters(){
  let out = [...VIDEOS];
  if(state.q){
    const q = state.q.toLowerCase();
    out = out.filter(v => (v.title+" "+(v.notes||'')).toLowerCase().includes(q));
  }
  if(state.topics.size){
    out = out.filter(v => v.topics && v.topics.some(t => state.topics.has(t)));
  }
  switch(state.sort){
    case 'newest': out.sort((a,b)=> (b.date||'').localeCompare(a.date||'')); break;
    case 'oldest': out.sort((a,b)=> (a.date||'').localeCompare(b.date||'')); break;
    case 'az': out.sort((a,b)=> (a.title||'').localeCompare(b.title||'')); break;
    case 'za': out.sort((a,b)=> (b.title||'').localeCompare(a.title||'')); break;
  }
  return out;
}


function renderArchive(){
  // update controls
  qEl.value = state.q;
  sortEl.value = state.sort;
  // chip states
  $$('.chip').forEach(ch => ch.classList.toggle('active', state.topics.has(ch.textContent)));

  const rows = applyFilters();
  gridEl.innerHTML = '';
  for(const v of rows){
    const card = document.createElement('article');
    card.className = 'card';
    card.innerHTML = `
      <a class="thumb" href="?v=${v.id}" >
        <img alt="${v.title}" loading="lazy" src="${v.thumb}">
        <span class="badge">${v.date ? new Date(v.date).toLocaleDateString() : ''}</span>
      </a>
      <div class="body">
        <div class="titleLine"><a href="?v=${v.id}">${v.title}</a></div>
        <div class="meta card-desc">${v.notes || ''}</div>
        <div class="topics">${(v.topics||[]).map(t=>`<span class="topic">${t}</span>`).join('')}</div>
        <div class="actions">
          <a class="btn" href="?v=${v.id}">Sources</a>
          <a class="btn" href="${v.url}" target="_blank" rel="noopener">Watch on YouTube</a>
        </div>
      </div>`;
    gridEl.appendChild(card);
  }
  countEl.textContent = `${rows.length} video${rows.length===1?'':'s'} shown`;
  emptyEl.style.display = rows.length ? 'none' : 'block';
  // reflect query in URL for shareability
  const params = new URLSearchParams();
  if(state.q) params.set('q', state.q);
  if(state.sort !== 'newest') params.set('sort', state.sort);
  if(state.topics.size) params.set('topics', [...state.topics].join(','));
  history.replaceState(null, '', params.toString() ? `?${params}` : location.pathname + location.hash);

  renderSponsors('#sponsorbar-archive');
}

qEl.addEventListener('input', e => { state.q = e.target.value; renderArchive(); });
sortEl.addEventListener('change', e => { state.sort = e.target.value; renderArchive(); });

if (compactBtn){
  const applyCompact = () => {
    document.documentElement.style.setProperty('--desc-lines', compactMode ? '4' : '8');
    compactBtn.textContent = compactMode ? 'Compact cards' : 'Roomy cards';
  };
  compactBtn.addEventListener('click', () => { compactMode = !compactMode; applyCompact(); });
  applyCompact();
}


// ======= Detail (per‑video references) =======
function getVideoById(id){ return VIDEOS.find(v => v.id === id) }

function jaccard(a, b){
  const A = new Set(a||[]), B = new Set(b||[]);
  if(!A.size && !B.size) return 0;
  let inter = 0; for(const x of A) if(B.has(x)) inter++;
  return inter / (A.size + B.size - inter || 1);
}

function getRelatedVideos(v, max=4){
  // 1) Manual list first
  const manual = (v.related||[])
    .map(id => VIDEOS.find(x => x.id === id))
    .filter(Boolean);
  if(manual.length) return manual.slice(0, max);

  // 2) Fallback: by topic overlap + mild date boost
  const score = (cand) => {
    if(cand.id === v.id) return -1;
    const sTopics = jaccard(v.topics, cand.topics); // 0..1
    const d = Math.abs(new Date(cand.date||'2000-01-01') - new Date(v.date||'2000-01-01')) / (1000*60*60*24);
    const recencyBoost = Math.max(0, 1 - Math.min(d, 365)/365); // within 1 year boosts a bit
    return sTopics*0.85 + recencyBoost*0.15;
  };
  return [...VIDEOS]
    .sort((a,b)=> score(b) - score(a))
    .filter(x => x.id !== v.id)
    .slice(0, max);
}

function renderRelated(v){
  const host = $('#related');
  host.innerHTML = '';
  if(!v.related?.length) return;
  const section = document.createElement('section');
  const h = document.createElement('h3'); h.textContent = 'Related videos';
  section.appendChild(h);

  const grid = document.createElement('div');
  grid.className = 'related-grid';
  for(const id of v.related){
    const r = getVideoById(id);
    if(!r) continue;
    const card = document.createElement('a');
    card.className = 'related-card';
    card.href = `?v=${r.id}`;
    card.innerHTML = `
      <div class="thumb"><img src="${r.thumb}" alt="${r.title}"></div>
      <div class="body">
        <div class="titleLine">${r.title}</div>
        <div class="meta">${r.date || ''}</div>
      </div>`;
    grid.appendChild(card);
  }
  section.appendChild(grid);
  host.appendChild(section);
}

function renderRefs(v){
  const host = $('#refs');
  host.innerHTML = '';
  const groups = [
    ['papers','Papers'],
    ['books','Books'],
    ['talks','Talks & Lectures'],
    ['datasets','Datasets'],
    ['other','Other']
  ];
  const refs = v.refs || {};
  let any = false;

  for(const [key,label] of groups){
    const items = refs[key] || [];
    if(items.length){
      any = true;

      const sec = document.createElement('section');
      sec.className = 'refgroup';

      const h = document.createElement('h3');
      h.textContent = label;
      sec.appendChild(h);

      const ul = document.createElement('ul');

      // --- this is the corrected inner section ---
      for(const it of items){
        const li = document.createElement('li');

        if(it.u){  // valid link present
          const a = document.createElement('a');
          a.href = it.u;
          a.target = '_blank';
          a.rel = 'noopener';
          a.textContent = it.t || it.u;
          li.appendChild(a);
        } else {  // just plain text
          const span = document.createElement('span');
          span.textContent = it.t || '';
          li.appendChild(span);
        }

        if(it.n){  // optional note
          const note = document.createElement('span');
          note.className = 'meta';
          note.style.marginLeft = '8px';
          note.textContent = `– ${it.n}`;
          li.appendChild(note);
        }

        ul.appendChild(li);
      }
      // --- end of fix ---

      sec.appendChild(ul);
      host.appendChild(sec);
    }
  }

  if(!any){
    const p = document.createElement('p');
    p.className = 'meta';
    p.textContent = 'No references added yet.';
    host.appendChild(p);
  }
}

function showDetail(id){
  const v = getVideoById(id);
  if(!v){ history.pushState(null,'',location.pathname); route(); return; }
  $('#dTitle').textContent = v.title || id;
  $('#dDate').textContent = v.date ? new Date(v.date).toLocaleDateString() : '';
  $('#dTopics').textContent = (v.topics||[]).join(' · ');
  $('#dThumb').src = v.thumb || (ytIdFromUrl(v.url) ? `https://img.youtube.com/vi/${ytIdFromUrl(v.url)}/hqdefault.jpg` : '');
upgradeYouTubeThumb($('#dThumb'), v.url);
  $('#dThumb').alt = v.title || '';
  $('#dBadge').textContent = v.date ? new Date(v.date).toLocaleDateString() : '';
  $('#dWatch').href = v.url || '#';
  $('#dNotes').textContent = v.notes || '';
  renderRefs(v);
  renderRelated(v);
  renderSponsors('#sponsorbar-detail');

  // toggle views
  archiveEl.style.display = 'none';
  $('#controls').style.display = 'none';
  detailEl.style.display = 'block';
}

// ======= Navigation & routing =======
function showSection(id){
  archiveEl.style.display = 'none';
  $('#controls').style.display = 'none';
  detailEl.style.display = 'none';
  $('#support').style.display = 'none';
  $('#contact').style.display = 'none';
  $(id).style.display = 'block';
  if(id === '#archive'){ $('#controls').style.display = 'flex'; }
}

function wireStaticLinks(){
  $('#lPatreon').href = SUPPORT_LINKS.patreon;
  $('#lKofi').href = SUPPORT_LINKS.kofi;
  $('#lPaypal').href = SUPPORT_LINKS.paypal;
  $('#lMerch').href = SUPPORT_LINKS.merch;
  const e = CONTACT.email;
  if(e){ const a = $('#bizEmail'); a.href = 'mailto:'+e; a.textContent = e; }
}

function goArchive(){
  history.pushState(null, '', location.pathname + '#archive');
  // Reset basic state; keep it simple for now
  state = { q: '', topics: new Set(), sort: 'newest' };
  renderArchive();
  showSection('#archive');
}

function route(){
  const p = new URLSearchParams(location.search);
  const vid = p.get('v');
  const hash = location.hash.replace('#','');
  if(vid){ showDetail(vid); return; }
  if(hash === 'support'){ renderSponsors('#sponsorbar-support'); wireStaticLinks(); showSection('#support'); return; }
  if(hash === 'contact'){ renderSponsors('#sponsorbar-contact'); wireStaticLinks(); showSection('#contact'); return; }
  // default: archive
  const topics = (p.get('topics')||'').split(',').filter(Boolean);
  if(topics.length) state.topics = new Set(topics);
  const sort = p.get('sort');
  if(sort) state.sort = sort;
  state.q = p.get('q') || '';
  renderArchive();
  showSection('#archive');
}

window.addEventListener('hashchange', route);

// ======= ID Validator & self-tests =======
function validateVideoIDs(list){
  const seen = new Set();
  const pattern = /^[0-9]{8}(-[a-z0-9]+)*$/; // e.g., 20251027-long, 20251027-short-01
  for(const v of list){
    if(!v.id){ console.warn('❌ Missing id in', v.title); continue; }
    if(seen.has(v.id)) console.warn('⚠️ Duplicate id:', v.id);
    seen.add(v.id);
    if(!pattern.test(v.id)) console.warn('⚠️ Invalid id format:', v.id, 'Expected YYYYMMDD-suffix');
    if(v.id.length>48) console.warn('⚠️ ID very long:', v.id);
  }
  if(!list.length) console.warn('⚠️ No videos found');
  else console.log('✅ ID validation complete:', list.length, 'entries');
}


let sponsorPulseTimer = null;

function startSponsorBreathing() {
  // Accessibility: don't animate if user prefers reduced motion
  if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) return;

  const bar = document.querySelector('#sponsorbar-top');
  if (!bar) return;

  // clear any old interval (in case we re-rendered)
  if (sponsorPulseTimer) clearInterval(sponsorPulseTimer);

  const pulse = () => {
    const imgs = Array.from(bar.querySelectorAll('img'));
    if (!imgs.length) return;
    const el = imgs[Math.floor(Math.random() * imgs.length)];
    // restart animation by toggling the class
    el.classList.remove('sponsor-breathe');
    // force reflow so the animation can replay
    void el.offsetWidth;
    el.classList.add('sponsor-breathe');
  };

  // fire occasionally; first after a short delay so page settles
  setTimeout(pulse, 1500);
  sponsorPulseTimer = setInterval(pulse, 15000);
}


// ======= Init =======
loadData()
  .then(()=>{
    validateVideoIDs(VIDEOS);
    buildChips();
    renderSponsors('#sponsorbar-top');   // existing
    startSponsorBreathing();             // ← add this
    route();
  })
  .catch(e=>{
    console.error('Data load failed', e);
    if (!VIDEOS.length) VIDEOS = VIDEOS_FALLBACK;
    if (!SPONSORS.length) SPONSORS = SPONSORS_FALLBACK;
    validateVideoIDs(VIDEOS);
    buildChips();
    renderSponsors('#sponsorbar-top');
    startSponsorBreathing();             // ← add here too
    route();
  });


// Client-side Archive navigation to avoid sandbox navigation blocks
const navArchive = document.getElementById('navArchive');
if(navArchive){ navArchive.addEventListener('click', (e)=>{ e.preventDefault(); goArchive(); }); }
const backArchive = document.getElementById('backArchive');
if(backArchive){ backArchive.addEventListener('click', (e)=>{ e.preventDefault(); goArchive(); }); }

// Tiny export helper (exports current in-memory VIDEOS)
$('#export').addEventListener('click', e =>{
  e.preventDefault();
  const blob = new Blob([JSON.stringify(VIDEOS, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = Object.assign(document.createElement('a'), {href:url, download:'videos.json'});
  document.body.appendChild(a); a.click(); a.remove(); setTimeout(()=>URL.revokeObjectURL(url),500);
});
</script>
</body>
</html>
